import asyncio
from random import choice
import discord
from discord.ext import commands
from discord import app_commands
from discord.ui import Button, View
import json
import os
import requests
from dotenv import load_dotenv
from urllib.parse import quote
import logging

# Carregar vari√°veis do .env
load_dotenv()
TOKEN = os.getenv("DISCORD_TOKEN")
OMDB_API_KEY = os.getenv("OMDB_API_KEY")

# Configurar logging
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")

# Configurar intents do bot
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# Nome do arquivo onde os filmes s√£o armazenados
ARQUIVO_FILMES = "filmes.json"

# Fun√ß√£o para carregar os filmes do arquivo JSON
def carregar_filmes():
    if os.path.exists(ARQUIVO_FILMES):
        with open(ARQUIVO_FILMES, "r", encoding="utf-8") as f:
            return json.load(f)
    return []

# Fun√ß√£o para salvar os filmes no arquivo JSON
def salvar_filmes(filmes):
    with open(ARQUIVO_FILMES, "w", encoding="utf-8") as f:
        json.dump(filmes, f, indent=4, ensure_ascii=False)

# Carregar filmes ao iniciar
filmes = carregar_filmes()

# Fun√ß√£o para buscar filmes usando a API OMDB
def buscar_filmes(query):
    try:
        url = f"http://www.omdbapi.com/?s={quote(query)}&apikey={OMDB_API_KEY}"
        resposta = requests.get(url).json()
        if resposta.get("Response") == "True":
            return resposta["Search"]  # Retorna a lista de filmes
    except Exception as e:
        logging.error(f"Erro ao buscar filmes: {e}")
    return []  # Retorna uma lista vazia se n√£o encontrar ou houver erro

'''
# Fun√ß√£o para buscar detalhes de um filme usando a API OMDB
def buscar_detalhes_filme(nome):
    try:
        url = f"http://www.omdbapi.com/?t={quote(nome)}&apikey={OMDB_API_KEY}"
        resposta = requests.get(url).json()
        if resposta.get("Response") == "True":
            return resposta  # Retorna os detalhes do filme
    except Exception as e:
        logging.error(f"Erro ao buscar detalhes do filme: {e}")
    return []  # Retorna None se n√£o encontrar ou houver erro
'''
# Classe para criar bot√µes de sele√ß√£o de filmes
class SelecionarFilmeView(View):
    def __init__(self, filmes, ctx):
        super().__init__(timeout=30)
        self.filmes = filmes
        self.ctx = ctx

    async def interaction_check(self, interaction: discord.Interaction) -> bool:
        return interaction.user == self.ctx.author

    @discord.ui.button(label="1", style=discord.ButtonStyle.primary)
    async def selecionar_1(self, interaction: discord.Interaction, button: Button):
        await self.processar_selecao(interaction, 0)

    @discord.ui.button(label="2", style=discord.ButtonStyle.primary)
    async def selecionar_2(self, interaction: discord.Interaction, button: Button):
        await self.processar_selecao(interaction, 1)

    @discord.ui.button(label="3", style=discord.ButtonStyle.primary)
    async def selecionar_3(self, interaction: discord.Interaction, button: Button):
        await self.processar_selecao(interaction, 2)

    async def processar_selecao(self, interaction: discord.Interaction, index: int):
        if index >= len(self.filmes):
            await interaction.response.send_message("‚ö†Ô∏è Sele√ß√£o inv√°lida!", ephemeral=True)
            return

        filme_selecionado = self.filmes[index]
        detalhes = buscar_filmes(filme_selecionado["Title"])

        if not detalhes:
            await interaction.response.send_message("‚ö†Ô∏è N√£o foi poss√≠vel obter detalhes do filme.", ephemeral=True)
            return

        # Verificar se o filme j√° est√° na lista
        if any(f["nome"].lower() == detalhes["Title"].lower() for f in filmes):
            await interaction.response.send_message(f'‚ö†Ô∏è O filme "**{detalhes["Title"]}**" j√° est√° na lista!', ephemeral=True)
            return

        filme_data = {
            "nome": detalhes["Title"],
            "adicionado_por": self.ctx.author.name,
            "assistido": False,
            "capa": detalhes.get("Poster", None)
        }

        filmes.append(filme_data)
        salvar_filmes(filmes)

        mensagem = f'üé¨ Filme "**{detalhes["Title"]}**" adicionado por {self.ctx.author.name}!'
        if detalhes.get("Poster"):
            await interaction.response.send_message(mensagem)
            await interaction.followup.send(detalhes["Poster"])
        else:
            await interaction.response.send_message(mensagem)

        self.stop()

    async def on_timeout(self):
        await self.ctx.send("‚è∞ Tempo esgotado! Nenhum filme foi selecionado.")

@bot.hybrid_command(name="addfilme", description="Adiciona um filme √† lista com nome corrigido e capa")
@app_commands.describe(query="O nome do filme que voc√™ deseja adicionar")
async def addfilme(ctx: commands.Context, *, query: str):
    """Adiciona um filme √† lista com nome corrigido e capa"""
    if len(query) > 100:
        await ctx.send("‚ö†Ô∏è Nome do filme inv√°lido! O nome deve ter no m√°ximo 100 caracteres.", ephemeral=True)
        return

    await ctx.defer()  # Indica que o bot est√° processando a solicita√ß√£o
    await asyncio.sleep(2)  # Adiciona um atraso de 2 segundos

    resultados = buscar_filmes(query)
    if not resultados:
        await ctx.send("‚ö†Ô∏è Nenhum filme encontrado com esse nome.", ephemeral=True)
        return

    # Limitar a 3 resultados para simplificar
    resultados = resultados[:3]

    # Criar mensagem com os resultados
    embed = discord.Embed(title="üé¨ Resultados da Busca", color=discord.Color.blue())
    for i, filme in enumerate(resultados, start=1):
        embed.add_field(name=f"{i}. {filme['Title']} ({filme['Year']})", value="\u200b", inline=False)

    # Adicionar bot√µes para sele√ß√£o
    view = SelecionarFilmeView(resultados, ctx)
    await ctx.send(embed=embed, view=view)

# Comando h√≠brido para listar filmes
@bot.hybrid_command(name="listar", description="Lista todos os filmes organizadamente")
async def listar(ctx: commands.Context):
    """Lista todos os filmes organizadamente"""
    if not filmes:
        await ctx.send("üé¨ Nenhum filme adicionado ainda!", ephemeral=True)
        return

    assistidos = [f for f in filmes if f["assistido"]]
    nao_assistidos = [f for f in filmes if not f["assistido"]]

    embed = discord.Embed(title="üé¨ Lista de Filmes", color=discord.Color.blue())

    if nao_assistidos:
        embed.add_field(name="üìå Para assistir", value="\n".join([f"üîπ *{f['nome']}* (Adicionado por {f['adicionado_por']})" for f in nao_assistidos]), inline=False)

    if assistidos:
        embed.add_field(name="‚úÖ J√° assistidos", value="\n".join([f"‚úîÔ∏è *{f['nome']}* (Adicionado por {f['adicionado_por']})" for f in assistidos]), inline=False)

    await ctx.send(embed=embed)

# Comando h√≠brido para remover um filme
@bot.hybrid_command(name="remover", description="Remove um filme da lista")
@app_commands.describe(filme="O nome do filme que voc√™ deseja remover")
async def remover(ctx: commands.Context, *, filme: str):
    """Remove um filme da lista"""
    filme_encontrado = encontrar_filme_por_nome(filme)
    if filme_encontrado:
        filmes.remove(filme_encontrado)
        salvar_filmes(filmes)
        await ctx.send(f'üóëÔ∏è Filme "{filme}" removido com sucesso!')
    else:
        await ctx.send(f'‚ö†Ô∏è Filme "{filme}" n√£o encontrado na lista.', ephemeral=True)

# Comando h√≠brido para marcar um filme como assistido
@bot.hybrid_command(name="assistido", description="Marca um filme como assistido")
@app_commands.describe(filme="O nome do filme que voc√™ deseja marcar como assistido")
async def assistido(ctx: commands.Context, *, filme: str):
    """Marca um filme como assistido"""
    filme_encontrado = encontrar_filme_por_nome(filme)
    if filme_encontrado:
        filme_encontrado["assistido"] = True
        salvar_filmes(filmes)
        await ctx.send(f'‚úÖ Filme "{filme}" marcado como assistido!')
    else:
        await ctx.send(f'‚ö†Ô∏è Filme "{filme}" n√£o encontrado na lista.', ephemeral=True)

# Comando h√≠brido para sortear um filme
@bot.hybrid_command(name="sortear", description="Sorteia um filme ainda n√£o assistido")
async def sortear(ctx: commands.Context):
    """Sorteia um filme ainda n√£o assistido"""
    nao_assistidos = [f for f in filmes if not f["assistido"]]
    if nao_assistidos:
        filme_sorteado = choice(nao_assistidos)
        mensagem = f'üé≤ O filme sorteado √©: **{filme_sorteado["nome"]}** (Adicionado por {filme_sorteado["adicionado_por"]})!'
        if filme_sorteado.get("capa"):
            await ctx.send(mensagem)
            await ctx.send(filme_sorteado["capa"])
        else:
            await ctx.send(mensagem)
    else:
        await ctx.send("‚ö†Ô∏è Todos os filmes j√° foram assistidos! Adicione mais filmes.", ephemeral=True)

# Fun√ß√£o para encontrar um filme pelo nome
def encontrar_filme_por_nome(nome):
    for f in filmes:
        if f["nome"].lower() == nome.lower():
            return f
    return None

@bot.hybrid_command(name="infofilme", description="Exibe informa√ß√µes detalhadas de um filme")
@app_commands.describe(filme="O nome do filme que voc√™ deseja buscar")
async def infofilme(ctx: commands.Context, *, filme: str):
    """Busca e exibe informa√ß√µes detalhadas de um filme"""
    detalhes = buscar_filmes(filme)
    
    if not detalhes:
        await ctx.send(f'‚ö†Ô∏è N√£o foi poss√≠vel encontrar detalhes para "{filme}".', ephemeral=True)
        return
    
    embed = discord.Embed(
        title=detalhes["Title"],
        description=detalhes.get("Plot", "Sem descri√ß√£o dispon√≠vel."),
        color=discord.Color.blue()
    )
    
    embed.add_field(name="üóìÔ∏è Ano", value=detalhes.get("Year", "Desconhecido"), inline=True)
    embed.add_field(name="üé≠ G√™nero", value=detalhes.get("Genre", "Desconhecido"), inline=True)
    embed.add_field(name="üé¨ Diretor", value=detalhes.get("Director", "Desconhecido"), inline=False)
    embed.add_field(name="‚≠ê Nota IMDb", value=detalhes.get("imdbRating", "N/A"), inline=True)
    embed.add_field(name="üìú Classifica√ß√£o", value=detalhes.get("Rated", "N/A"), inline=True)
    embed.add_field(name="‚è≥ Dura√ß√£o", value = detalhes.get("Runtime","N/A"), inline=True)
    
    if detalhes.get("Poster") and detalhes["Poster"] != "N/A":
        embed.set_thumbnail(url=detalhes["Poster"])
    
    await ctx.send(embed=embed)


@bot.hybrid_command(name="ajuda", description="Exibe instru√ß√µes sobre como usar o bot")
async def ajuda(ctx: commands.Context):
    """Exibe instru√ß√µes sobre como usar o bot"""
    embed = discord.Embed(
        title="üìú Instru√ß√µes para Usar o TigreFlix Bot",
        description="Aqui est√£o todos os comandos dispon√≠veis e como us√°-los:",
        color=discord.Color.blue()
    )

    # Adicionar campos para cada comando
    embed.add_field(
        name="üé¨ Adicionar um Filme",
        value="Use `/addfilme query: Nome do Filme` para adicionar um filme √† lista. O bot buscar√° o filme e permitir√° que voc√™ selecione a op√ß√£o correta.",
        inline=False
    )

    embed.add_field(
        name="üìã Listar Filmes",
        value="Use `/listar` para ver todos os filmes na lista, separados em 'Para assistir' e 'J√° assistidos'.",
        inline=False
    )

    embed.add_field(
        name="üóëÔ∏è Remover um Filme",
        value="Use `/remover filme: Nome do Filme` para remover um filme da lista.",
        inline=False
    )

    embed.add_field(
        name="‚úÖ Marcar um Filme como Assistido",
        value="Use `/assistido filme: Nome do Filme` para marcar um filme como assistido.",
        inline=False
    )

    embed.add_field(
        name="üé≤ Sortear um Filme",
        value="Use `/sortear` para sortear um filme que ainda n√£o foi assistido.",
        inline=False
    )

    embed.add_field(
        name="üõ†Ô∏è Ver Comandos Dispon√≠veis",
        value="Use `/ajuda` para ver esta mensagem novamente.",
        inline=False
    )

    # Adicionar uma nota final
    embed.set_footer(text="D√∫vidas? √â s√≥ chamar! üé•üçø")

    # Enviar a mensagem
    await ctx.send(embed=embed) 

    
@bot.event
async def on_ready():
    logging.info(f'ü§ñ Bot {bot.user} est√° online!')
    try:
        synced = await bot.tree.sync()
        logging.info(f"‚úÖ {len(synced)} comandos sincronizados.")
    except Exception as e:
        logging.error(f"Erro ao sincronizar comandos: {e}")

bot.run(TOKEN)